function h(){window.ymaps.ready(()=>{window.myMap=new window.ymaps.Map("map",{center:[59.9386,30.3141],zoom:12,controls:[],suppressMapOpenBlock:!0}),window.myPlacemark=new window.ymaps.Placemark([59.9386,30.3141],{},{iconLayout:"default#image",iconImageHref:"images/map-pin.png",iconImageSize:[26,37],iconImageOffset:[-13,-37],draggable:!0}),window.myMap.geoObjects.add(window.myPlacemark);let t=document.getElementById("address");function o(r){window.ymaps.geocode(r).then(s=>{let c=s.geoObjects.get(0).getAddressLine();t&&(t.value=c)})}window.myPlacemark.events.add("dragend",()=>{let r=window.myPlacemark.geometry.getCoordinates();o(r)}),window.myMap.events.add("click",r=>{let s=r.get("coords");window.myPlacemark.geometry.setCoordinates(s),o(s)});let e="\u0433. \u0421\u0430\u043D\u043A\u0442-\u041F\u0435\u0442\u0435\u0440\u0431\u0443\u0440\u0433, \u043F\u0440. \u041F\u0440\u043E\u0441\u0432\u0435\u0449\u0435\u043D\u0438\u044F, \u0434. 99, \u043A\u0432. 152";window.ymaps.geocode(e).then(r=>{let s=r.geoObjects.get(0).geometry.getCoordinates();window.myMap.setCenter(s,16),window.myPlacemark.geometry.setCoordinates(s),t&&(t.value=e)})})}function b(){let t="fe79d58476db2b061699143532f7c3b8dc2d1766",o=document.getElementById("address"),e=document.getElementById("search-address"),r=document.getElementById("suggestions");async function s(n){if(!n)return;let i=await(await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Token ${t}`},body:JSON.stringify({query:n})})).json();if(r.innerHTML="",i.suggestions.length===0){let a=document.createElement("li");a.textContent="\u0410\u0434\u0440\u0435\u0441 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D",r.appendChild(a)}else i.suggestions.forEach((a,m)=>{let d=document.createElement("li");d.classList.add("suggestions__item"),d.textContent=a.value,m===0&&d.classList.add("suggestions__item--active"),d.addEventListener("click",()=>{document.querySelectorAll(".suggestions__item").forEach(f=>f.classList.remove("suggestions__item--active")),d.classList.add("suggestions__item--active"),o.value=a.value,r.style.display="none";let u=a.data.geo_lat,p=a.data.geo_lon;u&&p&&window.myPlacemark&&window.myMap&&(window.myPlacemark.geometry.setCoordinates([u,p]),window.myMap.setCenter([u,p],16))}),r.appendChild(d)});r.style.display="block"}e.addEventListener("click",()=>{let n=o.value.trim();s(n)}),o.addEventListener("input",()=>{let n=o.value.trim();n.length>2?s(n):r.style.display="none"})}function g(t){t.forEach(o=>{if(o.removed)return;let e=document.querySelector(`.cart-list__item[data-id="${o.id}"]`);if(!e)return;let r=e.querySelector(".cart-list__title"),s=e.querySelector(".cart-list__price"),n=e.querySelector(".cart-list__qty-input"),c=e.querySelector(".cart-list__total"),i=e.querySelector(".cart-list__old-price"),a=e.querySelector(".cart-list__old-total"),m=e.querySelector(`input[name="size-${o.id}"][value="${o.size}"]`),d=e.querySelector(`input[name="color-${o.id}"][value="${o.color}"]`),u=e.querySelector(".cart-list__qty-btn--minus");r&&(r.textContent=o.title),s&&(s.textContent=o.price.toLocaleString()+" \u20BD"),n&&(n.value=o.qty),c&&(c.textContent=(o.qty*o.price).toLocaleString()+" \u20BD"),i&&(o.oldPrice?(i.textContent=o.oldPrice.toLocaleString()+" \u20BD",i.style.display="inline"):i.style.display="none"),a&&(o.oldPrice?(a.textContent=(o.oldPrice*o.qty).toLocaleString()+" \u20BD",a.style.display="inline"):a.style.display="none"),m&&(m.checked=!0),d&&(d.checked=!0),u&&(u.disabled=o.qty<=1)})}function O(t){return t.map(o=>{if(o.removed)return null;let e=document.querySelector(`.cart-list__item[data-id="${o.id}"]`);if(!e)return null;let r=e.querySelector(`input[name="size-${o.id}"]:checked`)?.value,s=e.querySelector(`input[name="color-${o.id}"]:checked`)?.value,n=Number(e.querySelector(".cart-list__qty-input")?.value||1);return{id:o.id,size:r,color:s,qty:n}}).filter(Boolean)}function v(t,o={code:"",value:0}){let e=document.querySelector(".cart__aside-price--discount"),r=document.querySelector(".cart__aside-price--action"),s=document.querySelector(".cart__aside-price--promo"),n=document.querySelector(".cart__aside-price--total"),c=document.querySelector(".cart__aside-price--delivery"),i=document.querySelectorAll(".cart__summary-price"),a=0,m=0;t.forEach(_=>{a+=_.price*_.qty,m+=(_.oldPrice||_.price)*_.qty});let d=o.code||"",u=o.value||0,p=m-a,f=p+u,l=200,y=a+l-u;return e&&(e.textContent=f>0?`\u2212 ${f.toLocaleString()} \u20BD`:"0 \u20BD"),r&&(r.textContent=p>0?`\u2212 ${p.toLocaleString()} \u20BD`:"0 \u20BD"),s&&(s.textContent=u>0?`\u2212 ${u.toLocaleString()} \u20BD`:"0 \u20BD"),n&&(n.textContent=a.toLocaleString()+" \u20BD"),c&&(c.textContent=l.toLocaleString()+" \u20BD"),i.forEach(_=>{_.textContent=y.toLocaleString()+" \u20BD"}),{promoCode:d,promoValue:u,grandTotal:y,discount:f,action:p,delivery:l}}function w(t,o){let e=document.querySelector(".cart__promo-input"),r=document.querySelector(".cart__promo-label"),s=document.querySelector(".cart__promo-button"),n=document.querySelector(".cart__promo-message"),c=document.querySelector(".cart__row--promo");e.addEventListener("input",()=>{e.value.trim()!==""?(s.classList.add("visible"),e.classList.remove("cart__promo-input--error"),r.classList.remove("cart__promo-label--error")):(s.classList.remove("visible"),n.textContent="")}),e.addEventListener("blur",()=>{e.value.trim()===""&&(s.classList.remove("visible"),n.textContent="")});let i=null;s.addEventListener("click",a=>{a.preventDefault();let m=e.value.trim().toUpperCase();if(n.className="cart__promo-message",i=null,t[m]){let d=t[m],u=0;if(d.type==="fixed")u=d.discount;else if(d.type==="percent"){let p=o.reduce((f,l)=>f+l.price*l.qty,0);u=Math.floor(p*(d.discount/100))}i={code:m,value:u},v(o,i),n.textContent=`${m} - \u043A\u0443\u043F\u043E\u043D \u043F\u0440\u0438\u043C\u0435\u043D\u0435\u043D`,n.classList.add("cart__promo--success"),c.style.display="flex"}else n.textContent=`${m} - \u043A\u0443\u043F\u043E\u043D \u043D\u0435 \u043F\u0440\u0438\u043C\u0435\u043D\u0435\u043D`,n.classList.add("cart__promo--error"),e.classList.add("cart__promo-input--error"),r.classList.add("cart__promo-label--error"),c.style.display="flex"})}var E=null;async function N(){return E||(E=await(await fetch("./mocks/cart.json")).json()),E}var C=null;async function j(){return C||(C=await(await fetch("./mocks/promo.json")).json()),C}function x(t){document.querySelectorAll(".cart-list__item").forEach(o=>{let e=Number(o.dataset.id),r=o.querySelector(".cart-list__qty-btn--minus"),s=o.querySelector(".cart-list__qty-btn--plus");r.addEventListener("click",()=>{let n=t.find(c=>c.id===e);n.qty>1&&(n.qty--,g(t),v(t))}),s.addEventListener("click",()=>{let n=t.find(c=>c.id===e);n.qty++,g(t),v(t)})})}var T={};function k(t){let o=document.querySelector(".cart-list");t.forEach(e=>{let r=document.querySelector(`.cart-list__item[data-id="${e.id}"]`);r&&(T[e.id]=r.innerHTML)}),o.addEventListener("click",e=>{let r=e.target.closest("[data-action]");if(!r)return;let s=r.dataset.action,n=r.closest(".cart-list__item"),c=Number(n.dataset.id),i=t.find(a=>a.id===c);if(i)switch(s){case"remove":i.removed=!0,n.classList.add("cart-list__item--removed"),n.innerHTML=`
          <div class="cart-list__divider">
              <div class="cart-list__placeholder">
                <span class="cart-list__placeholder-text">
                  \u0422\u043E\u0432\u0430\u0440 <span class="cart-list__placeholder-text--bold">${i.title}</span> \u0431\u044B\u043B \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B.
                </span>
                <button type="button" class="cart-list__remove cart-list__remove-final" data-action="remove-final" aria-label="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043E\u043A\u043E\u043D\u0447\u0430\u0442\u0435\u043B\u044C\u043D\u043E">
                  <svg class="cart-list__icon">
                    <use href="icons/stack.svg#close"></use>
                  </svg>
                </button>
            </div>
            <button type="button" data-action="restore" class="cart-list__restore">\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C</button>
          </div>
        `;break;case"restore":i.removed=!1,n.innerHTML=T[c],n.classList.remove("cart-list__item--removed");break;case"remove-final":t.splice(t.indexOf(i),1),n.remove();break}})}function M(t){let o=t.querySelector("#firstname"),e=t.querySelector("#lastname"),r=t.querySelector("#phone"),s=t.querySelector("#email");t.querySelectorAll(".error").forEach(m=>m.remove());let n=!0,c=/^[A-Za-zА-Яа-яЁё]{2,}$/,i=/^(\+7|7|8)?\d{7,}$/,a=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return c.test(o.value.trim())||(n=!1,S(o,"\u0417\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u0438\u043C\u044F \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E")),c.test(e.value.trim())||(n=!1,S(e,"\u0417\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u0444\u0430\u043C\u0438\u043B\u0438\u044E \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E")),i.test(r.value.trim())||(n=!1,S(r,"\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u044B\u0439 \u043D\u043E\u043C\u0435\u0440 \u0442\u0435\u043B\u0435\u0444\u043E\u043D\u0430")),a.test(s.value.trim())||(n=!1,S(s,"\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u0443\u044E \u043F\u043E\u0447\u0442\u0443")),q(o,c,"\u0417\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u0438\u043C\u044F \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E"),q(e,c,"\u0417\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u0444\u0430\u043C\u0438\u043B\u0438\u044E \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E"),q(r,i,"\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u044B\u0439 \u043D\u043E\u043C\u0435\u0440 \u0442\u0435\u043B\u0435\u0444\u043E\u043D\u0430"),q(s,a,"\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u0443\u044E \u043F\u043E\u0447\u0442\u0443"),n}function q(t,o,e){t.dataset.validationAttached||(t.addEventListener("input",()=>{o.test(t.value.trim())?z(t):S(t,e)}),t.addEventListener("blur",()=>{o.test(t.value.trim())||S(t,e)}),t.dataset.validationAttached="true")}function S(t,o){let e=t.closest(".form__field");if(!e)return;let r=e.querySelector(".error");r&&r.remove(),t.classList.add("form__field-input--error");let s=e.querySelector(".form__field-label");s&&s.classList.add("form__field-label--error");let n=document.createElement("span");n.classList.add("error"),n.textContent=o,e.appendChild(n)}function z(t){let o=t.closest(".form__field");if(!o)return;let e=o.querySelector(".error");e&&e.remove(),t.classList.remove("form__field-input--error");let r=o.querySelector(".form__field-label");r&&r.classList.remove("form__field-label--error")}function L(t,o=""){let e=document.querySelector(t);if(!e)return;if(o){let s=e.querySelector(".order-overlay__message");s&&(s.textContent=o)}e.classList.add("active");let r=e.querySelector(".order-overlay__close");r&&r.addEventListener("click",()=>{e.classList.remove("active")},{once:!0}),e.addEventListener("click",s=>{s.target===e&&e.classList.remove("active")},{once:!0})}function P(t,o){t.addEventListener("submit",e=>{e.preventDefault();let r=document.querySelector("#promo"),s=document.querySelector(".cart__promo-message"),n=document.querySelector(".cart__promo-button"),c=document.querySelector(".cart__promo-btn"),i=O(o),a=v(o);function m(l,y,_,A){y&&(y.value=""),_&&(_.textContent=""),A&&A.classList.remove("visible"),l.reset()}let d={IDLE:"\u041E\u0444\u043E\u0440\u043C\u0438\u0442\u044C \u0437\u0430\u043A\u0430\u0437",SENDING:"\u041E\u0444\u043E\u0440\u043C\u043B\u044F\u044E..."},u=l=>{c.disabled=l,c.textContent=l?d.SENDING:d.IDLE};if(!M(t)){let l=t.querySelector(".error");if(l){l.scrollIntoView({behavior:"smooth",block:"center"});let y=l.closest(".form__field").querySelector("input, textarea");y&&y.focus()}return}let f=new FormData(t);f.append("cart-info",JSON.stringify(i)),f.append("summary-data",JSON.stringify(a));for(let[l,y]of f.entries())console.log(l,y);u(!0),fetch("https://httpbin.org/post",{method:"POST",body:f}).then(l=>{if(!l.ok)throw new Error("Network response was not ok");return l.json()}).then(l=>{console.log("\u0423\u0441\u043F\u0435\u0448\u043D\u043E \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u043E:",l),m(t,r,s,n),L("#order-overlay","\u0412\u0430\u0448 \u0437\u0430\u043A\u0430\u0437 \u043F\u0440\u0438\u043D\u044F\u0442!")}).catch(l=>{console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0442\u043F\u0440\u0430\u0432\u043A\u0435:",l),L("#order-overlay","\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437")}).finally(()=>{u(!1)})})}function B(){let t=document.getElementById("comment"),o=document.querySelector(".form__comment-hint"),e=142;function r(){let s=t.value.length;o.textContent=`\u0418\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u043E ${s}/${e} \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432`}r(),t.addEventListener("input",r)}function I(){let t=document.querySelector(".burger"),o=document.getElementById("mobile"),e=o.querySelector(".mobile-menu__close"),r=document.querySelector(".menu-list");t.addEventListener("click",()=>{o.classList.add("active"),e.classList.add("mobile-menu__close--active");let s=o.querySelector(".mobile-menu__list.menu-list");s&&r&&(s.innerHTML="",r.querySelectorAll(".menu-list__item").forEach(n=>{let c=n.cloneNode(!0);c.classList.add("menu-list__item--mobile");let i=c.querySelector(".menu-list__link");i&&i.classList.add("menu-list__link--mobile"),s.appendChild(c)}))}),e.addEventListener("click",()=>{o.classList.remove("active"),e.classList.remove("mobile-menu__close--active")})}function D(){let t=document.getElementById("map"),o=document.querySelector(".form__contacts"),e=document.getElementById("form");window.innerWidth>=1200?(e.insertAdjacentElement("afterend",t),console.log("\u041A\u0430\u0440\u0442\u0430 \u0432 main")):(o.appendChild(t),console.log("\u041A\u0430\u0440\u0442\u0430 \u0432 contacts")),window.myMap&&window.myMap.container.fitToViewport()}function $(){D(),window.addEventListener("resize",D)}document.addEventListener("DOMContentLoaded",async()=>{let[t,o]=await Promise.all([N(),j()]);h(),b(),g(t),v(t),w(o,t),x(t),k(t),B();let e=document.querySelector("#form");P(e,t),I(),$()});

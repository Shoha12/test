function S(){window.ymaps.ready(()=>{window.myMap=new window.ymaps.Map("map",{center:[59.9386,30.3141],zoom:12,controls:[],suppressMapOpenBlock:!0}),window.myPlacemark=new window.ymaps.Placemark([59.9386,30.3141],{},{iconLayout:"default#image",iconImageHref:"images/map-pin.png",iconImageSize:[26,37],iconImageOffset:[-13,-37],draggable:!0}),window.myMap.geoObjects.add(window.myPlacemark);let e=document.getElementById("address");function t(r){window.ymaps.geocode(r).then(n=>{let s=n.geoObjects.get(0).getAddressLine();e&&(e.value=s)})}window.myPlacemark.events.add("dragend",()=>{let r=window.myPlacemark.geometry.getCoordinates();t(r)}),window.myMap.events.add("click",r=>{let n=r.get("coords");window.myPlacemark.geometry.setCoordinates(n),t(n)});let o="\u0433. \u0421\u0430\u043D\u043A\u0442-\u041F\u0435\u0442\u0435\u0440\u0431\u0443\u0440\u0433, \u043F\u0440. \u041F\u0440\u043E\u0441\u0432\u0435\u0449\u0435\u043D\u0438\u044F, \u0434. 99, \u043A\u0432. 152";window.ymaps.geocode(o).then(r=>{let n=r.geoObjects.get(0).geometry.getCoordinates();window.myMap.setCenter(n,16),window.myPlacemark.geometry.setCoordinates(n),e&&(e.value=o)})})}function q(){let e="fe79d58476db2b061699143532f7c3b8dc2d1766",t=document.getElementById("address"),o=document.getElementById("search-address"),r=document.getElementById("suggestions");o.addEventListener("click",async()=>{let n=t.value.trim();if(!n)return;let s=await(await fetch("https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/address",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Token ${e}`},body:JSON.stringify({query:n})})).json();if(r.innerHTML="",s.suggestions.length===0){let a=document.createElement("li");a.textContent="\u0410\u0434\u0440\u0435\u0441 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D",r.appendChild(a)}else s.suggestions.forEach(a=>{let i=document.createElement("li");i.textContent=a.value,i.addEventListener("click",()=>{t.value=a.value,r.style.display="none";let l=a.data.geo_lat,d=a.data.geo_lon;l&&d&&window.myPlacemark&&window.myMap&&(window.myPlacemark.geometry.setCoordinates([l,d]),window.myMap.setCenter([l,d],16))}),r.appendChild(i)});r.style.display="block"})}function p(e){e.forEach(t=>{if(!t.removed){let o=document.querySelector(`.cart-list__item[data-id="${t.id}"]`);if(!o)return;o.querySelector(".cart-list__title").textContent=t.title;let r=o.querySelector(".cart-list__price");r&&(r.textContent=t.price.toLocaleString()+" \u20BD");let n=o.querySelector(".cart-list__qty-input");n.value=t.qty;let c=o.querySelector(".cart-list__total");c&&(c.textContent=(t.qty*t.price).toLocaleString()+" \u20BD");let s=o.querySelector(".cart-list__old-price");s&&(t.oldPrice?(s.textContent=t.oldPrice.toLocaleString()+" \u20BD",s.style.display="inline"):s.style.display="none");let a=o.querySelector(".cart-list__old-total");a&&(t.oldPrice?(a.textContent=(t.oldPrice*t.qty).toLocaleString()+" \u20BD",a.style.display="inline"):a.style.display="none");let i=o.querySelector(`input[name="size-${t.id}"][value="${t.size}"]`);i&&(i.checked=!0);let l=o.querySelector(`input[name="color-${t.id}"][value="${t.color}"]`);l&&(l.checked=!0);let d=o.querySelector(".cart-list__qty-btn--minus");d&&(d.disabled=t.qty<=1)}})}function B(e){return e.map(t=>{let o=document.querySelector(`.cart-list__item[data-id="${t.id}"]`);return!o||t.removed?null:{id:t.id,size:o.querySelector(`input[name="size-${t.id}"]:checked`)?.value,color:o.querySelector(`input[name="color-${t.id}"]:checked`)?.value,qty:Number(o.querySelector(".cart-list__qty-input")?.value||1)}}).filter(Boolean)}function u(e,t={code:"",value:0}){let o=0,r=0;e.forEach(f=>{o+=f.price*f.qty,f.oldPrice?r+=f.oldPrice*f.qty:r+=f.price*f.qty});let n=t.code||"",c=Number(t)||0,s=r-o,a=s+c,i=200,l=o+i-c,d=document.querySelector(".cart__aside-price--discount");d&&(d.textContent=a>0?`\u2212 ${a.toLocaleString()} \u20BD`:"0 \u20BD");let m=document.querySelector(".cart__aside-price--action");m&&(m.textContent=s>0?`\u2212 ${s.toLocaleString()} \u20BD`:"0 \u20BD");let v=document.querySelector(".cart__aside-price--promo");v&&(v.textContent=c>0?`\u2212 ${c.toLocaleString()} \u20BD`:"0 \u20BD");let _=document.querySelector(".cart__aside-price--total");_&&(_.textContent=r.toLocaleString()+" \u20BD");let $=document.querySelector(".cart__aside-price--delivery");$&&($.textContent=i.toLocaleString()+" \u20BD");let M=document.querySelectorAll(".cart__summary-price");return M&&M.forEach(f=>{f.textContent=l.toLocaleString()+" \u20BD"}),{promoCode:n,promoValue:c,grandTotal:l,discount:a,action:s,delivery:i}}function h(e,t){let o=document.querySelector(".cart__promo-input"),r=document.querySelector(".cart__promo-button"),n=document.querySelector(".cart__promo-message"),c=document.querySelector(".cart__row--promo");o.addEventListener("input",()=>{o.value.trim()!==""?r.classList.add("visible"):(r.classList.remove("visible"),n.textContent="")}),o.addEventListener("blur",()=>{o.value.trim()===""&&(r.classList.remove("visible"),n.textContent="")});let s=null;r.addEventListener("click",a=>{a.preventDefault();let i=o.value.trim().toUpperCase();if(n.className="cart__promo-message",s=null,e[i]){let l=e[i],d=0;if(l.type==="fixed")d=l.discount;else if(l.type==="percent"){let m=t.reduce((v,_)=>v+_.price*_.qty,0);d=Math.floor(m*(l.discount/100))}s=d,u(t,s),n.textContent=`${i} - \u043A\u0443\u043F\u043E\u043D \u043F\u0440\u0438\u043C\u0435\u043D\u0435\u043D`,n.classList.add("cart__promo--success"),c.style.display="flex"}else n.textContent=`${i} - \u043A\u0443\u043F\u043E\u043D \u043D\u0435 \u043F\u0440\u0438\u043C\u0435\u043D\u0435\u043D`,n.classList.add("cart__promo--error"),c.style.display="flex"})}var w=null;async function I(){return w||(w=await(await fetch("./mocks/cart.json")).json()),w}var b=null;async function A(){return b||(b=await(await fetch("./mocks/promo.json")).json()),b}function C(e){document.querySelectorAll(".cart-list__item").forEach(t=>{let o=Number(t.dataset.id),r=t.querySelector(".cart-list__qty-btn--minus"),n=t.querySelector(".cart-list__qty-btn--plus");r.addEventListener("click",()=>{let c=e.find(s=>s.id===o);c.qty>1&&(c.qty--,p(e),u(e))}),n.addEventListener("click",()=>{let c=e.find(s=>s.id===o);c.qty++,p(e),u(e)})})}var O={};function L(e){let t=document.querySelector(".cart-list");e.forEach(o=>{let r=document.querySelector(`.cart-list__item[data-id="${o.id}"]`);r&&(O[o.id]=r.innerHTML)}),t.addEventListener("click",o=>{let r=o.target.closest("[data-action]");if(!r)return;let n=r.dataset.action,c=r.closest(".cart-list__item"),s=Number(c.dataset.id),a=e.find(i=>i.id===s);if(a)switch(n){case"remove":a.removed=!0,c.classList.add("cart-list__item--removed"),c.innerHTML=`
          <div class="cart-list__divider">
              <div class="cart-list__placeholder">
                <span class="cart-list__placeholder-text">
                  \u0422\u043E\u0432\u0430\u0440 <span class="cart-list__placeholder-text--bold">${a.title}</span> \u0431\u044B\u043B \u0443\u0434\u0430\u043B\u0451\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B.
                </span>
                <button type="button" class="cart-list__remove cart-list__remove-final" data-action="remove-final" aria-label="\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043E\u043A\u043E\u043D\u0447\u0430\u0442\u0435\u043B\u044C\u043D\u043E">
                  <svg class="cart-list__icon">
                    <use href="icons/stack.svg#close"></use>
                  </svg>
                </button>
            </div>
            <button type="button" data-action="restore" class="cart-list__restore">\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C</button>
          </div>
        `;break;case"restore":a.removed=!1,c.innerHTML=O[s],c.classList.remove("cart-list__item--removed");break;case"remove-final":e.splice(e.indexOf(a),1),c.remove();break}})}function E(e){let t=e.querySelector("#firstname"),o=e.querySelector("#lastname"),r=e.querySelector("#phone"),n=e.querySelector("#email");e.querySelectorAll(".error").forEach(l=>l.remove());let c=!0,s=/^[A-Za-zА-Яа-яЁё]{2,}$/,a=/^(\+7|7|8)?\d{7,}$/,i=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return s.test(t.value.trim())||(c=!1,y(t,"\u0417\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u0438\u043C\u044F \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E")),s.test(o.value.trim())||(c=!1,y(o,"\u0417\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u0444\u0430\u043C\u0438\u043B\u0438\u044E \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E")),a.test(r.value.trim())||(c=!1,y(r,"\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u044B\u0439 \u043D\u043E\u043C\u0435\u0440 \u0442\u0435\u043B\u0435\u0444\u043E\u043D\u0430")),i.test(n.value.trim())||(c=!1,y(n,"\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u0443\u044E \u043F\u043E\u0447\u0442\u0443")),g(t,s,"\u0417\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u0438\u043C\u044F \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E"),g(o,s,"\u0417\u0430\u043F\u043E\u043B\u043D\u0438\u0442\u0435 \u0444\u0430\u043C\u0438\u043B\u0438\u044E \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E"),g(r,a,"\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u044B\u0439 \u043D\u043E\u043C\u0435\u0440 \u0442\u0435\u043B\u0435\u0444\u043E\u043D\u0430"),g(n,i,"\u0423\u043A\u0430\u0436\u0438\u0442\u0435 \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u0443\u044E \u043F\u043E\u0447\u0442\u0443"),c}function g(e,t,o){e.dataset.validationAttached||(e.addEventListener("input",()=>{t.test(e.value.trim())?j(e):y(e,o)}),e.addEventListener("blur",()=>{t.test(e.value.trim())||y(e,o)}),e.dataset.validationAttached="true")}function y(e,t){let o=e.closest(".form__field");if(!o)return;let r=o.querySelector(".error");r&&r.remove(),e.classList.add("form__field-input--error");let n=o.querySelector(".form__field-label");n&&n.classList.add("form__field-label--error");let c=document.createElement("span");c.classList.add("error"),c.textContent=t,o.appendChild(c)}function j(e){let t=e.closest(".form__field");if(!t)return;let o=t.querySelector(".error");o&&o.remove(),e.classList.remove("form__field-input--error");let r=t.querySelector(".form__field-label");r&&r.classList.remove("form__field-label--error")}function x(e,t){e.addEventListener("submit",o=>{o.preventDefault();let r=B(t),n=u(t);if(!E(e)){let d=e.querySelector(".error");if(d){d.scrollIntoView({behavior:"smooth",block:"center"});let m=d.closest(".form__field").querySelector("input, textarea");m&&m.focus()}return}let s=new FormData(e);s.append("cart-info",JSON.stringify(r)),s.append("summary-data",JSON.stringify(n));for(let[d,m]of s.entries())console.log(d,m);let a=document.querySelector("#promo"),i=document.querySelector(".cart__promo-message");a&&(a.value=""),i&&(i.textContent="");let l=document.querySelector(".cart__promo-button");l&&l.classList.remove("visible"),e.reset()})}function k(){let e=document.getElementById("comment"),t=document.querySelector(".form__comment-hint"),o=142;function r(){let n=e.value.length;t.textContent=`\u0418\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043D\u043E ${n}/${o} \u0441\u0438\u043C\u0432\u043E\u043B\u043E\u0432`}r(),e.addEventListener("input",r)}function P(){let e=document.querySelector(".burger"),t=document.querySelector(".menu-list");!e||!t||e.addEventListener("click",()=>{e.classList.toggle("burger--active"),t.classList.toggle("menu-list--open")})}document.addEventListener("DOMContentLoaded",async()=>{let[e,t]=await Promise.all([I(),A()]);S(),q(),p(e),u(e),h(t,e),C(e),L(e),k();let o=document.querySelector("#form");x(o,e),P()});
